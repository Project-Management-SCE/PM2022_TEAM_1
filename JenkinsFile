pipeline {
    agent none
    stages {

        stage('Build') {
            agent {
                docker {
                    image 'python:3.7'
                }
            }
            steps {
		            withEnv(["HOME=${env.WORKSPACE}"]) {
		               sh 'pip install -r requirements.txt'
		               sh 'pip install pymongo==3.12.1'
		               sh 'pip install dnspython'
		               sh 'python manage.py makemigrations'
		               sh 'python manage.py migrate'
					}
			}
        }
        stage(' Unit Tests') {
            agent {
                docker {
                    image 'python:3.7'
                }
            }
            steps {
		            withEnv(["HOME=${env.WORKSPACE}"]) {
                sh 'python manage.py test'
		      }
			}
        }
        stage(' integration-test') {
            agent {
                docker {
                    image 'python:3.7'
                }
            }
            steps {
		            withEnv(["HOME=${env.WORKSPACE}"]) {
                sh 'python manage.py test --tag=integration-test'
		      }
			}
        }
	}
}
